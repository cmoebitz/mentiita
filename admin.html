<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Menti ITA – Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-cloud@1/build/d3.layout.cloud.js"></script>
<style>
 body{font-family:system-ui,Roboto,sans-serif;margin:16px}
 canvas{max-width:650px}
 #cloud svg{width:650px;height:400px}
</style>
</head>
<body>
<h1>Menti ITA – Live-Ergebnisse</h1>

<h2>Balkendiagramm (MC-Fragen)</h2>
<canvas id="mcChart"></canvas>

<h2>Wortwolke (Freitext)</h2>
<div id="cloud"></div>

<script>
/* ----- Metadaten ----- */
const MC_IDS = ["q1","q2","q4","q7"];
const FT_IDS = ["q3","q5","q6"];
const NICE = {q1:"Vorher",q2:"Zukünftig",q4:"Hilfreich",q7:"Fuel"};

/* ----- Chart init ----- */
const mcCtx = document.getElementById('mcChart');
const mcChart = new Chart(mcCtx, {
  type:'bar',
  data:{labels:[],datasets:[]},
  options:{responsive:true,plugins:{legend:{position:'top'}}}
});

/* ----- Wortwolke helper ----- */
function drawCloud(wordArray){
  d3.select("#cloud").selectAll("*").remove();
  const svg = d3.select("#cloud").append("svg")
                .attr("viewBox","0 0 650 400");
  d3.layout.cloud().size([650,400])
    .words(wordArray)
    .padding(4)
    .rotate(()=>~~(Math.random()*2)*90)
    .fontSize(d=>10+6*d.size)
    .on("end",words=>{
      svg.append("g")
         .attr("transform","translate(325,200)")
         .selectAll("text")
         .data(words)
         .enter().append("text")
           .style("font-size",d=>d.size+"px")
           .style("font-family","Impact")
           .attr("text-anchor","middle")
           .attr("transform",d=>`translate(${d.x},${d.y})rotate(${d.rotate})`)
           .text(d=>d.text);
    }).start();
}

/* ----- Listener ----- */
firebase.database().ref('responses').on('value', snap=>{
  const raw = Object.values(snap.val()||{});
  console.log("RAW", raw);              // << Debug-Ausgabe

  /* === Balken === */
  const allLabels = new Set();
  const datasets = MC_IDS.map(id=>{
    const counts={};
    raw.forEach(r => [].concat(r[id]||[]).forEach(a=>{
      counts[a] = (counts[a]||0)+1;
      allLabels.add(a);
    }));
    return {label:NICE[id],data:[],backgroundColor:Chart.defaults.backgroundColor};
  });

  const labelArr = Array.from(allLabels);
  datasets.forEach(ds=>{
    const id = MC_IDS[datasets.indexOf(ds)];
    const counts={};
    raw.forEach(r => [].concat(r[id]||[]).forEach(a=>counts[a]=(counts[a]||0)+1));
    ds.data = labelArr.map(l=>counts[l]||0);
  });

  mcChart.data.labels = labelArr;
  mcChart.data.datasets = datasets;
  mcChart.update();

  /* === Wortwolke === */
  const wordsCount = {};
  FT_IDS.forEach(id=>{
    raw.forEach(r => [].concat(r[id]||[]).forEach(w=>{
      w = w.trim().toLowerCase();
      if(w) wordsCount[w] = (wordsCount[w]||0)+1;
    }));
  });
  const wordArr = Object.entries(wordsCount).map(([text,size])=>({text,size}));
  drawCloud(wordArr);
});
</script>
</body>
</html>
